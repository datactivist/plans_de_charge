---
title: Plans de charge au `r format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%d %B %Y")`
output: 
  flexdashboard::flex_dashboard:
    theme: readable
    vertical_layout: fill
    #logo: logo_datactivist.png
    storyboard: true
            
knit: (
  function(inputFile, encoding) { 
    
    rmarkdown::render(inputFile, params = "ask",  
      encoding    = encoding,
      output_dir = "annees", 
      output_file = paste0(tools::file_path_sans_ext(inputFile), "_", format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%Y"), ".html")) })
---

<style>

.nav-tabs-custom > .nav-tabs > li.active {
border-top-color: #E5555C;
}

body {
text-align: justify;
background: #f2f2f2;
}

.navbar-logo {
  margin-top: 4px;
}

.storyboard-nav .sbframelist {
margin: 0 auto;
width: 94%;
height: 50px;
overflow: hidden;
text-shadow: none;
margin-bottom: 8px;
}

.storyboard-nav .sbnext, .storyboard-nav .sbprev {
float: left;
width: 2%;
height: 45px;
font-size: 40px;
}

.column-box {
background-color: #f2f2f2;
border-color: #f2f2f2;
}

.storyboard-nav .sbframelist ul li.active {
  color: #fff;
  background: #B8B8B8;
}

.chart-shim {
overflow: auto;
}

</style>


```{r eval=FALSE, include=FALSE}
# Paramètres des themes : https://github.com/rstudio/flexdashboard/blob/feature/logo-and-favicon/inst/rmarkdown/templates/flex_dashboard/resources/flexdashboard.css 
# Changer background couleur d'un seul élément (chart) : https://stackoverflow.com/questions/54538451/how-to-add-background-colours-to-boxes-on-rmarkdown-flexdashboard
```


```{r setup, include=FALSE}
library(flexdashboard)
knitr::opts_chunk$set(echo = FALSE, 
                      eval = TRUE, 
                      message = FALSE, 
                      warning = FALSE,
                      collapse = TRUE,  
                      fig.show = "hold",
                      out.width = "100%")  # all chunk options at https://yihui.org/knitr/options/
```

```{r include=FALSE}
# Packages nécessaires à l'analyse
packages = c("tidyverse", "plotly", "gt", "gtExtras", "tm", "ggwordcloud", "mondate", "ggiraph")
## Installation des packages si besoin et chargement des librairies
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)
# Données
data <- read_csv("project.task.csv") |> 
  rename(debut_projet = `Projet/Date de début`,
         fin_projet = `Projet/Date de fin de validité`,
         debut = `Date de début`,
         fin = `Date de fin`,
         tache_parente = `Tâche parente`,
         etat = `Étiquette d'état Kanban`,
         label = `Étiquettes`,
         etape = `Étape`,
         todo = Titre,
         `Heures prévues` = `Heures prévues initialement`,
         etat_projet = `Projet/État du Projet`) |> 
  mutate(type = case_when(!is.na(tache_parente) ~ "Sous-tâche", .default = "Tâche"),
         taches = coalesce(tache_parente, paste0(todo, 1)),
         `Heures restantes` = `Heures prévues` - `Heures passées`) |> 
  select(Projet, debut_projet, fin_projet, etat_projet, todo, type, tache_parente, taches, Description, Progression, debut, fin, etape, etat, label, `Heures passées`:`Heures restantes`, `Assigné à`, Facturable) |> 
  arrange(Projet, taches) |> 
  group_by(Projet) |> 
  arrange(desc(taches)) |> 
  mutate(id = row_number()) |> 
  mutate(todo = fct_reorder(todo, -id)) |> 
  ungroup()
```


Datactivist
=====================================  



Column {data-width=190}
-----------------------------------------------------------------------

**Missions en cours** :


### Box 1

```{r echo=FALSE}
# All icons here : https://ionicons.com/v2/cheatsheet.html or https://fontawesome.com/icons?d=gallery&p=2 
en_cours <- data |> filter(etat_projet != "Terminé", etat_projet != "Terminé mais pas facturé",
                           (any(debut_projet <= Sys.Date()) & any(fin_projet >= Sys.Date())) | (any(debut <= Sys.Date()) & any(fin >= Sys.Date())), 
                           .by = Projet)
n1 <- en_cours |> distinct(Projet) |> na.omit() |> nrow()
valueBox(n1, color = "#CC0033", caption = ifelse(n1 > 1, "Missions", "Mission"))
```

### Box 2

```{r echo=FALSE}
n2 <- en_cours |> summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
n2_factures <- en_cours |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
valueBox(n2, color = "#FF9933", 
         caption = ifelse(n2 > 1, paste("Jours prévus dont", n2_factures, "facturables"), paste("Jour prévu dont", n2_factures, "facturable"))) 
```

### Box 3

```{r echo=FALSE}
n3 <- en_cours |> summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
n3_factures <- en_cours |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  filter_all(all_vars(!grepl("déplacement|deplacement|Déplacement|Deplacement", .))) |> 
  summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
valueBox(n3, color = "#FFCC00", 
         caption = ifelse(n3 > 1, paste("Jours réalisés dont", n3_factures, "facturables"), paste("Jour réalisé dont", n3_factures, "facturable")))
```

### Box 4

```{r echo=FALSE}
n4 <- en_cours |> summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
n4_factures <- en_cours |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
valueBox(n4, color = "#339900", 
         caption = ifelse(n4 > 1, paste("Jours restants dont", n4_factures, "facturables"), paste("Jour restant dont", n4_factures, "facturable")))
```




Column {data-width=190}
-----------------------------------------------------------------------

**Missions en `r format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%Y")`** :



### Box 1

```{r echo=FALSE}
annee <- data |> filter(any(debut >= "2023-01-01") | any(debut_projet >= "2023-01-01"), .by = Projet)
n5 <- annee |> distinct(Projet) |> na.omit() |> nrow()
valueBox(n5, color = "#CC0033", caption = ifelse(n5 > 1, "Missions", "Mission"))
```

### Box 2

```{r echo=FALSE}
n6 <- annee |> summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
n6_factures <- annee |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
valueBox(n6, color = "#FF9933", 
         caption = ifelse(n6 > 1, paste("Jours prévus dont", n6_factures, "facturables"), paste("Jour prévu dont", n6_factures, "facturable"))) 
```

### Box 3

```{r echo=FALSE}
n7 <- annee |> summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
n7_factures <- annee |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  filter_all(all_vars(!grepl("déplacement|deplacement|Déplacement|Deplacement", .))) |> 
  summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
valueBox(n7, color = "#FFCC00", 
         caption = ifelse(n7 > 1, paste("Jours réalisés dont", n7_factures, "facturables"), paste("Jour réalisé dont", n7_factures, "facturable")))
```

### Box 4

```{r echo=FALSE}
n8 <- annee |> summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
n8_factures <- annee |> 
  filter(Projet != "Tâches non facturables à timesheeter",
         label != "Heures supplémentaires" | is.na(label),
         Facturable == TRUE) |> 
  summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
valueBox(n8, color = "#339900", 
         caption = ifelse(n8 > 1, paste("Jours restants dont", n8_factures, "facturables"), paste("Jour restant dont", n8_factures, "facturable")))
```






Column {data-width=1200}{.tabset}
-----------------------------------------------------------------------


### Nuage de mots projets

```{r include=FALSE}
  # preparation des données
data_wordcloud <- glimpse(data)
corpus = Corpus(VectorSource(data_wordcloud$Projet))
  # mise en forme des mots
corpus = tm_map(corpus, PlainTextDocument) #Conversion to Lowercase
corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation) #Removing Punctuation
  # retrait des mots non désirés (pronoms, auxiliaires etc.)
ajout_stopwords <- c("d'", "d", "article", "articles", "Service producteur inconnu", "’")
remix_stopwords <- c(ajout_stopwords, stopwords("french"))  # adding own undesired words to stopwords
corpus = tm_map(corpus, removeWords, c("cloth", remix_stopwords)) #Remove stopwords
corpus = tm_map(corpus, stripWhitespace) # Eliminate white spaces
corpus[[1]][1] 
  # bon format du df
DTM <- TermDocumentMatrix(corpus)
mat <- as.matrix(DTM)
f <- sort(rowSums(mat),decreasing=TRUE) 
word_data <- data.frame(word = names(f),freq=f)
```

```{r echo=FALSE}
word_data |> 
  head(100) |> 
  ggplot(aes(label = word, size = freq)) +
          geom_text_wordcloud(color = rep_len(c('#173541','#E95459'), 100), family = "Montserrat") +
          scale_size_area(max_size = 15) +
          theme_minimal() +
          theme(plot.title = element_text(face = "bold", size = 15),
                plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))
```


### Nuage de mots tâches

```{r include=FALSE}
  # preparation des données
data_wordcloud <- glimpse(data)
corpus = Corpus(VectorSource(data_wordcloud$todo))
  # mise en forme des mots
corpus = tm_map(corpus, PlainTextDocument) #Conversion to Lowercase
corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation) #Removing Punctuation
  # retrait des mots non désirés (pronoms, auxiliaires etc.)
ajout_stopwords <- c("d'", "d", "article", "articles", "Service producteur inconnu", "’")
remix_stopwords <- c(ajout_stopwords, stopwords("french"))  # adding own undesired words to stopwords
corpus = tm_map(corpus, removeWords, c("cloth", remix_stopwords)) #Remove stopwords
corpus = tm_map(corpus, stripWhitespace) # Eliminate white spaces
corpus[[1]][1] 
  # bon format du df
DTM <- TermDocumentMatrix(corpus)
mat <- as.matrix(DTM)
f <- sort(rowSums(mat),decreasing=TRUE) 
word_data <- data.frame(word = names(f),freq=f)
```

```{r echo=FALSE}
word_data |> 
  head(60) |> 
  ggplot(aes(label = word, size = freq)) +
          geom_text_wordcloud(color = rep_len(c('#173541','#E95459'), 60), family = "Montserrat") +
          scale_size_area(max_size = 15) +
          theme_minimal() +
          theme(plot.title = element_text(face = "bold", size = 15),
                plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))
```



### Vue projets

```{r fig.width=15, fig.height=7}
graph <- annee |> 
  mutate(heures_dpcmt = case_when(grepl("déplacement|deplacement|Déplacement|Deplacement", label) == TRUE |
                                           grepl("déplacement|deplacement|Déplacement|Deplacement", todo) == TRUE ~ `Heures passées`, 
                                        .default = 0)) |> 
  mutate(assigne = paste(unique(na.omit(`Assigné à`)), collapse = ", "),
         `Jours passés` = round(sum(`Heures passées`) / 7, 1),
         `Jours prévus` = round(sum(`Heures prévues`) / 7, 0),
         `Jours restants` = round(sum(`Heures restantes`) / 7, 1),
         prog = (sum(`Heures passées`) - heures_dpcmt) / sum(`Heures prévues`) * 100,
         prog = case_when(prog >= 100 ~ 100, .default = prog),
         .by = Projet) |> 
  distinct(Projet, debut_projet, fin_projet, assigne, prog, `Jours passés`, `Jours restants`, `Jours prévus`, Facturable) |> 
  arrange(prog) |> 
  slice(1, .by = Projet) |> #garde la progression où les déplacements ont été enlevés
  filter(!is.na(debut_projet)) |> 
  mutate(debut_projet = as.POSIXct(debut_projet),
         nb_jours = round(as.numeric(difftime(fin_projet, debut_projet, units = "days"))*prog/100, 0),
         fin_réalisé = as.POSIXct(as.mondate(debut_projet, timeunits = "days") + nb_jours)) |> 
  rename(fin_restant = fin_projet) |> 
  pivot_longer(cols = c("fin_restant", "fin_réalisé"), names_prefix = "fin_", names_to = "etat", values_to = "fin") |> 
  arrange(Projet) |> 
  mutate(Projet = factor(Projet, levels = rev(unique(Projet)))) |> 
  ggplot() +
    geom_segment_interactive(aes(x = debut_projet, xend = fin, y = Projet, yend = Projet, colour = etat, size = `Jours prévus`,
                     tooltip = paste("Jours passés :", `Jours passés`, "\nJours restants :",  `Jours restants`, "\nAssigné à : ", assigne))) +
    geom_text(aes(x = fin, y = Projet, label = ifelse(etat == "restant", paste0("  ", `Jours prévus`, "J"), NA), hjust="bottom"), 
              size = 3, col = "#333333") +
    geom_vline(aes(xintercept = as.numeric(as.POSIXct(Sys.Date()))), col = "black", size = .35) +
    labs(title = "Jours prévus pour les projets de l'année", x = "", y = "") +
    scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) +
    scale_color_manual(values = c("réalisé" = "#51c230", "restant" = "#da4729")) +
    guides(col = guide_legend(title = "Progression", override.aes = list(lwd=2)),
           lwd = guide_legend(title = "Jours prévus")) +
    theme_bw()
girafe(print(graph), width_svg = 15, height_svg = 8)
```



### Vue personnes

```{r}
# Tableau des heures restantes divisées par mois jusqu'à fin tache / sous-tache
table <- en_cours |> 
  filter(`Assigné à` != "Cyril Morin") |> 
  mutate(sum_h_restantes = sum(`Heures restantes`), .by = c(`Assigné à`, Projet)) |> 
  distinct(`Assigné à`, Projet, debut_projet, fin_projet, sum_h_restantes) |> 
  mutate(nb_projets = n(), .by = `Assigné à`) |> 
  arrange(`Assigné à`) |> 
  mutate(`Assigné à` = factor(`Assigné à`, levels = rev(unique(`Assigné à`))))

# Dataviz
graph <- table |> 
  ggplot(aes(x = `Assigné à`, y = sum_h_restantes, fill = Projet, 
             text = ifelse(is.na(debut_projet), 
                           paste("Projet :", Projet, 
                          "\nNombre d'heures restantes :", round(sum_h_restantes, 0)),
                          paste("Projet :", Projet, "\nDu :", format(as.Date(debut_projet, format="%Y/%m/%d"),"%d %B %Y"), 
                                "au", format(as.Date(fin_projet, format="%Y/%m/%d"),"%d %B %Y"), 
                          "\nNombre d'heures restantes :", round(sum_h_restantes, 0))))) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = 0), col = "black", size = .35) +
  labs(title = "Heures restantes des projets en cours par personne",
       y = "Heures restantes sur les projets") +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  scale_fill_viridis_d() +
  theme_classic() +
  theme(legend.position = "none") +
  coord_flip()
ggplotly(graph, tooltip = c("text"))
```


Sarah
=====================================  

```{r}
salarie <- data |> filter(`Assigné à` == "Sarah Bourgouin")
annee <- salarie |> filter(any(debut >= "2023-01-01") | any(debut_projet >= "2023-01-01"), .by = Projet)
en_cours <- salarie |> filter(etat_projet != "Terminé", etat_projet != "Terminé mais pas facturé",
                            (any(debut_projet <= Sys.Date()) & any(fin_projet >= Sys.Date())) | (any(debut <= Sys.Date()) & any(fin >= Sys.Date())), 
                            .by = Projet)
```



Column {data-width=190}
-----------------------------------------------------------------------

**Missions en cours** :


### Box 1

```{r echo=FALSE}
# All icons here : https://ionicons.com/v2/cheatsheet.html or https://fontawesome.com/icons?d=gallery&p=2 
box1 <- function(data){
  n1 <- data |> distinct(Projet) |> na.omit() |> nrow()
  valueBox(n1, color = "#CC0033", caption = ifelse(n1 > 1, "Missions", "Mission"))
}
box1(en_cours)
```

### Box 2

```{r echo=FALSE}
box2 <- function(data){
  n2 <- data |> summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
  n2_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
  valueBox(n2, color = "#FF9933", 
           caption = ifelse(n2 > 1, paste("Jours prévus dont", n2_factures, "facturés"), paste("Jour prévu dont", n2_factures, "facturé"))) 
}
box2(en_cours)
```

### Box 3

```{r echo=FALSE}
box3 <- function(data){
  n3 <- data |> summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
  n3_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    filter_all(all_vars(!grepl("déplacement|deplacement|Déplacement|Deplacement", .))) |> 
    summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
  valueBox(n3, color = "#FFCC00", 
           caption = ifelse(n3 > 1, paste("Jours réalisés dont", n3_factures, "facturés"), paste("Jour réalisé dont", n3_factures, "facturé")))
}
box3(en_cours)
```

### Box 4

```{r echo=FALSE}
box4 <- function(data){
  n4 <- data |> summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
  n4_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
  valueBox(n4, color = "#339900", 
           caption = ifelse(n4 > 1, paste("Jours restants dont", n4_factures, "facturés"), paste("Jour restant dont", n4_factures, "facturé")))
}
box4(en_cours)
```




Column {data-width=190}
-----------------------------------------------------------------------

**Missions en `r format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%Y")`** :



### Box 5

```{r echo=FALSE}
box5 <- function(data){
  n5 <- data |> distinct(Projet) |> na.omit() |> nrow()
  valueBox(n5, color = "#CC0033", caption = ifelse(n5 > 1, "Missions", "Mission"))
}
box5(annee)
```

### Box 6

```{r echo=FALSE}
box6 <- function(data){
  n6 <- data |> summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
  n6_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    summarise(round(sum(`Heures prévues`, na.rm = T)/7, 0))
  valueBox(n6, color = "#FF9933", 
           caption = ifelse(n6 > 1, paste("Jours prévus dont", n6_factures, "facturés"), paste("Jour prévu dont", n6_factures, "facturé"))) 
}
box6(annee)
```

### Box 7

```{r echo=FALSE}
box7 <- function(data){
  n7 <- data |> summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
  n7_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    filter_all(all_vars(!grepl("déplacement|deplacement|Déplacement|Deplacement", .))) |> 
    summarise(round(sum(`Heures passées`, na.rm = T)/7, 0))
  valueBox(n7, color = "#FFCC00", 
           caption = ifelse(n7 > 1, paste("Jours réalisés dont", n7_factures, "facturés"), paste("Jour réalisé dont", n7_factures, "facturé")))
}
box7(annee)
```

### Box 8

```{r echo=FALSE}
box8 <- function(data){
  n8 <- data |> summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
  n8_factures <- data |> 
    filter(Projet != "Tâches non facturables à timesheeter",
           label != "Heures supplémentaires" | is.na(label),
           Facturable == TRUE) |> 
    summarise(round(sum(`Heures restantes`, na.rm = T)/7, 0))
  valueBox(n8, color = "#339900", 
           caption = ifelse(n8 > 1, paste("Jours restants dont", n8_factures, "facturés"), paste("Jour restant dont", n8_factures, "facturé")))
}
box8(annee)
```





Column {data-width=1200}{.tabset}
-----------------------------------------------------------------------


### Tableau global

    
```{r echo=FALSE, fig.height=2}
tableau_global <- function(data){
  # Tableau des projets
  table_projets <- data |> as.data.frame() |> 
    mutate(`Heures prévues` = round(`Heures prévues`, 1),
           `Heures passées` = round(`Heures passées`, 1),
           `Heures restantes` = round(`Heures restantes`, 1),
           ` ` = ifelse(type == "Tâche", "clipboard-check", "list-check"),
           état = case_when(etat == "En cours" ~ "circle", 
                            etat == "Prêt" ~ "circle-check", 
                            .default = NA_character_)) |> 
    arrange(Projet, taches) |> 
    rename(`heures prévues` = `Heures prévues`,
           `heures réalisées` = `Heures passées`,
           `heures restantes` = `Heures restantes`,
           `assigné` = `Assigné à`) |> 
    mutate(debut = as.Date(debut, format="%Y-%m-%d %H:%M:%S"),"%d-%m-%Y",
           fin = as.Date(fin, format="%Y-%m-%d %H:%M:%S"),"%d-%m-%Y") |> 
    select(Projet, ` `, type, todo, debut, fin, `heures prévues`:`heures restantes`, etape, état, `assigné`, id) |> 
    mutate_all(as.character) |> 
    mutate_at(vars(everything()), replace_na, replace = "") |> 
    mutate(`heures restantes` = as.numeric(`heures restantes`))
  
  # Représentation du tableau
  table_projets |> 
    group_by(Projet) |> 
    arrange(id) |> 
    select(-id) |> 
    gt(groupname_col = "Projet") |>
    gt_fa_column(column = ` `, direction = 1, palette = c("clipboard-check" = "black", "list-check" = "#e69f00")) |>  #icones
    gt_fa_column(column = état, direction = 1, height = '15px', prefer_type = "solid", 
                 palette = if (all(table_projets$état == "circle")) "#999999" 
                 else if (all(table_projets$état == "circle-check")) "green" else c("circle" = "#999999", "circle-check" = "green")) |> 
    gt_theme_nytimes() |> 
    tab_header(title = "Tableau global des tâches et sous-tâches en cours") |>
    tab_style(  #en gras
      style = list(cell_text(weight = "bold")),
      locations = cells_body(
      columns = Projet)) |>
    tab_style(  #en gras
      style = list(cell_text(weight = "bold")),
      locations = cells_body(
      columns = `heures restantes`)) |>
    tab_style(  #en gras
      style = list(cell_text(color = "#f44336")),
      locations = cells_body(
      columns = `heures restantes`,
      rows = `heures restantes` < 0)) |>
    tab_style(  #en gras
      style = list(cell_text(color = "#38761d")),
      locations = cells_body(
      columns = `heures restantes`,
      rows = `heures restantes` >= 0)) |>
    tab_options(table.font.size = 17,
                table.border.bottom.width = 1,
                table.border.bottom.color = "#CCCCCC",
                row_group.background.color = "grey")
}
tableau_global(en_cours)
```


### Heures prévues

```{r fig.width=15, fig.height=7}
heures_prevues <- function(data){
  graph <- data |> 
    filter(!is.na(debut) & etat_projet != "Terminé") |> 
    mutate(nb_jours = round(as.numeric(difftime(fin, debut, units = "days"))*Progression/100, 0),
           fin_réalisé = as.POSIXct(as.mondate(debut, timeunits = "days") + nb_jours),
           todo = fct_reorder(todo, -id)) |> 
    rename(fin_restant = fin) |> 
    pivot_longer(cols = c("fin_restant", "fin_réalisé"), names_prefix = "fin_", names_to = "prog", values_to = "fin") |> 
    ggplot() +
      geom_segment(aes(x = debut, xend = fin, y = todo, yend = todo, lwd = `Heures prévues`, colour = prog)) +
      geom_text(aes(x = fin, y = todo, label = ifelse(prog == "restant", paste0("  ", `Heures prévues`, "H"), NA), hjust="bottom"), 
                size = 3, col = "#333333") +
      geom_vline(aes(xintercept = as.numeric(as.POSIXct(Sys.Date()))), col = "black", size = .35) +
      labs(title = "Heures prévues par tâches et sous-tâches des projets", x = "", y = "") +
      ggforce::facet_col(facets = vars(Projet), scales = "free_y", space = "free") +
      scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 70)) +
      scale_color_manual(values = c("réalisé" = "#51c230", "restant" = "#da4729")) +
      guides(col = guide_legend(title = "Progression", override.aes = list(lwd=2)),
             lwd = guide_legend(title = "Heures prévues")) +
      theme_bw()
  girafe(print(graph), width_svg = 15, height_svg = 10)
}
heures_prevues(salarie)
```



### Heures restantes par semaine

```{r}
heures_semaine <- function(data){
  # Tableau des heures restantes divisées par semaine jusqu'à fin tache / sous-tache
  table_restant_semaine <- data |> 
    filter(`Heures restantes` > 0) |> 
    mutate(today = Sys.Date(),
           nb_week_left = round(as.numeric(difftime(fin, today, units = "weeks")), 0),
           hours_week_left = `Heures restantes` / nb_week_left) |> 
    filter(nb_week_left > 0) |> 
    select(Projet, todo, `Assigné à`, today, fin, nb_week_left, hours_week_left) |> 
    group_by(rn = row_number()) %>% 
    mutate(complete_date = list(seq(as.Date(today), as.Date(fin), by = 7))) |> 
    unnest()|> ungroup() |> select(-rn) |> 
    mutate(hours_total = ifelse(row_number() == 1, sum(hours_week_left), NA_real_), .by = complete_date) |> 
    arrange(complete_date) |> 
    mutate(hours_total = ifelse(row_number() == 1, hours_total, NA_real_), .by = hours_total) |> 
    mutate(todo = paste0(Projet, "\n", todo))
  
  # Dataviz
  graph <- table_restant_semaine |> 
    ggplot(aes(x = complete_date, y = hours_week_left, fill = todo, 
               text = paste0("Todo : ", todo, "\nProjet : ", Projet, "\nTemps : ", round(hours_week_left, 1), 
                             " heures restantes par semaine \n du ", format(today, '%d %B %Y'), " jusqu'au ", format(fin, '%d %B %Y')))) +
    geom_bar(stat = "identity") +
    geom_hline(aes(yintercept = round(32*0.857,0)), col = "red", size = .35) + #round(35*0.857,0) pour un temps plein
    geom_text(aes(x = complete_date, y = hours_total+2, label = ifelse(hours_total < 1, paste0(round(hours_total, 1), "H"), paste0(round(hours_total, 0), "H"))), 
              size = 3, vjust = 1) +
    labs(title = "Répartition des heures restantes par tâches et par semaine",
         y = "Heures restantes vendues par semaine") +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    scale_x_date(date_breaks = "months" , date_labels = "%b-%y") +
    scale_fill_viridis_d() +
    guides(fill = guide_legend(title = "Tâches et sous-tâches")) +
    theme_classic() +
    theme(axis.title.x = element_blank())
  ggplotly(graph, tooltip = c("text")) |> 
      layout(xaxis = list(autorange = TRUE), yaxis = list(autorange = TRUE))
}
heures_semaine(salarie)
```


### Heures restantes par mois

```{r}
heures_mois <- function(data){
  # Tableau des heures restantes divisées par mois jusqu'à fin tache / sous-tache
  table_restant_mois <- data |> 
    filter(`Heures restantes` > 0) |> 
    mutate(today = Sys.Date(),
           nb_month_left = round(as.numeric(difftime(fin, today, units = "weeks") /4.34524), 0),
           hours_month_left = case_when(nb_month_left >=1 ~ `Heures restantes` / nb_month_left,
                                        nb_month_left < 1 ~ `Heures restantes`)) |> 
    filter(nb_month_left > 0) |> 
    select(Projet, todo, `Assigné à`, today, fin, nb_month_left, hours_month_left) |> 
    group_by(rn = row_number()) %>% 
    mutate(complete_date = list(seq(as.Date(today), as.Date(fin), by = "month"))) |> 
    unnest()|> ungroup() |> select(-rn) |> 
    mutate(hours_total = ifelse(row_number() == 1, sum(hours_month_left), NA_real_), .by = complete_date) |> 
    arrange(complete_date) |> 
    mutate(hours_total = ifelse(row_number() == 1, hours_total, NA_real_), .by = hours_total) |> 
    mutate(todo = paste0(Projet, "\n", todo))
  
  # Dataviz
  graph <- table_restant_mois |> 
    ggplot(aes(x = complete_date, y = hours_month_left, fill = todo, 
               text = paste0("Todo : ", todo, "\nProjet : ", Projet, "\nTemps : ", round(hours_month_left, 1), 
                             " heures restantes par mois \n du ", format(today, '%d %B %Y'), " jusqu'au ", format(fin, '%d %B %Y')))) +
    geom_bar(stat = "identity") +
    geom_hline(aes(yintercept = round(17*0.857*8,0)), col = "red", size = .35) + #round(21*0.857*7,0)
    geom_text(aes(x = complete_date, y = hours_total+2, label = ifelse(hours_total < 1, paste0(round(hours_total, 1), "H"), paste0(round(hours_total, 0), "H"))), 
              size = 3, vjust = 1) +
    labs(title = "Répartition des heures restantes par tâches et par mois",
         y = "Heures restantes vendues par mois") +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    scale_x_date(date_breaks = "months" , date_labels = "%b-%y") +
    scale_fill_viridis_d() +
    guides(fill = guide_legend(title = "Tâches et sous-tâches")) +
    theme_classic() +
    theme(axis.title.x = element_blank())
  ggplotly(graph, tooltip = c("text")) |> 
      layout(xaxis = list(autorange = TRUE), yaxis = list(autorange = TRUE))
}
heures_mois(salarie)
```



Clément.M
=====================================  

```{r}
salarie <- data |> filter(`Assigné à` == "Clément Mandron")
annee <- salarie |> filter(any(debut >= "2023-01-01") | any(debut_projet >= "2023-01-01"), .by = Projet)
en_cours <- salarie |> filter(etat_projet != "Terminé", etat_projet != "Terminé mais pas facturé",
                            (any(debut_projet <= Sys.Date()) & any(fin_projet >= Sys.Date())) | (any(debut <= Sys.Date()) & any(fin >= Sys.Date())), 
                            .by = Projet)
```



Column {data-width=190}
-----------------------------------------------------------------------

**Missions en cours** :


### Box 1

```{r echo=FALSE}
box1(en_cours)
```

### Box 2

```{r echo=FALSE}
box2(en_cours)
```

### Box 3

```{r echo=FALSE}
box3(en_cours)
```

### Box 4

```{r echo=FALSE}
box4(en_cours)
```




Column {data-width=190}
-----------------------------------------------------------------------

**Missions en `r format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%Y")`** :



### Box 5

```{r echo=FALSE}
box5(annee)
```

### Box 6

```{r echo=FALSE}
box6(annee)
```

### Box 7

```{r echo=FALSE}
box7(annee)
```

### Box 8

```{r echo=FALSE}
box8(annee)
```



Column {data-width=1200}{.tabset}
-----------------------------------------------------------------------


### Tableau global

    
```{r echo=FALSE, fig.height=2}
tableau_global(en_cours)
```


### Heures prévues

```{r fig.width=15, fig.height=7}
heures_prevues(salarie)
```



### Heures restantes par semaine

```{r}
heures_semaine(salarie)
```


### Heures restantes par mois

```{r}
heures_mois(salarie)
```





Guillaume
=====================================  

```{r}
salarie <- data |> filter(`Assigné à` == "Guillaume Martin")
annee <- salarie |> filter(any(debut >= "2023-01-01") | any(debut_projet >= "2023-01-01"), .by = Projet)
en_cours <- salarie |> filter(etat_projet != "Terminé", etat_projet != "Terminé mais pas facturé",
                            (any(debut_projet <= Sys.Date()) & any(fin_projet >= Sys.Date())) | (any(debut <= Sys.Date()) & any(fin >= Sys.Date())), 
                            .by = Projet)
```



Column {data-width=190}
-----------------------------------------------------------------------

**Missions en cours** :


### Box 1

```{r echo=FALSE}
box1(en_cours)
```

### Box 2

```{r echo=FALSE}
box2(en_cours)
```

### Box 3

```{r echo=FALSE}
box3(en_cours)
```

### Box 4

```{r echo=FALSE}
box4(en_cours)
```




Column {data-width=190}
-----------------------------------------------------------------------

**Missions en `r format(as.Date(Sys.Date(), format="%Y/%m/%d"),"%Y")`** :



### Box 5

```{r echo=FALSE}
box5(annee)
```

### Box 6

```{r echo=FALSE}
box6(annee)
```

### Box 7

```{r echo=FALSE}
box7(annee)
```

### Box 8

```{r echo=FALSE}
box8(annee)
```



Column {data-width=1200}{.tabset}
-----------------------------------------------------------------------


### Tableau global

    
```{r echo=FALSE, fig.height=2}
tableau_global(en_cours)
```


### Heures prévues

```{r fig.width=15, fig.height=7}
heures_prevues(salarie)
```



### Heures restantes par semaine

```{r}
heures_semaine(salarie)
```


### Heures restantes par mois

```{r}
heures_mois(salarie)
```


